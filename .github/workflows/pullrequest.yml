# This workflow will build a package using Maven and then publish it to GitHub packages when a release is created
# For more information see: https://github.com/actions/setup-java/blob/main/docs/advanced-usage.md#apache-maven-with-a-settings-path

name: PR build check

on: pull_request

permissions:
  contents: read


env:
  ARTIFACTORY_DEV_USER: ${{ secrets.ARTIFACTORY_DEV_USER }}
  ARTIFACTORY_DEV_KEY: ${{ secrets.ARTIFACTORY_DEV_KEY }}
  ARTIFACTORY_RELEASE_USER: ${{ secrets.ARTIFACTORY_RELEASE_USER }}
  ARTIFACTORY_RELEASE_KEY: ${{ secrets.ARTIFACTORY_RELEASE_KEY }}
  # Set defaults here or as repository/organization variables (recommended)



jobs:
  maven:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        options: >-
          --health-cmd "pg_isready -U testuser"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:

    - name: Setup Maven Action
      uses: s4u/setup-maven-action@v1.19.0
      with:
          java-version: 17
          java-distribution: 'temurin'
          maven-version: 3.9.11
          settings-servers: |
            [{
              "id": "myreleaserepo",
              "username": "${env.ARTIFACTORY_RELEASE_USER}",
              "password": "${env.ARTIFACTORY_RELEASE_KEY}"
            },
            {
              "id": "mysnapshotrepo",
              "username": "${env.ARTIFACTORY_DEV_USER}",
              "password": "${env.ARTIFACTORY_DEV_KEY}"
            }]

    - name: Build
      run: mvn clean package --file pom.xml -DskipTests -B

    - name: Wait for Postgres to be ready
      run: |
          # Service container is reachable at localhost:5432 on GitHub-hosted runner
          for i in $(seq 1 30); do
            pg_isready -h localhost -p 5432 -U testuser && break
            echo "Waiting for postgres..."
            sleep 2
          done
      env:
        PGPASSWORD: testpass

    - name: Test
      run: mvn clean test -P citestcase -Ddb.url=$dburl -Ddb.username=$dbuser -Ddb.password=$dbpass
      env:
        dburl: "jdbc:postgresql://localhost:5432/testdb?serverTimezone=UTC"
        dbuser: testuser
        dbpass: testpass
    

